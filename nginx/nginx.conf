server {
    # Redireccionar HTTP a HTTPS
    listen 8000;
    # server_name localhost;
    return 301 https://$host$request_uri;
}

server {
    # listen 8000;
    # server_name localhost;

    # SSL configuration
		listen 443 ssl default_server;
		listen [::]:443 ssl default_server;
		ssl_certificate /etc/nginx/ssl/selfsigned.crt;
		ssl_certificate_key /etc/nginx/ssl/selfsigned.key;

    location /avatars/ {
        alias /usr/share/nginx/images/;
        # try_files $uri $uri/ =404;
        autoindex on;
        client_max_body_size 2M;
        add_header 'Access-Control-Allow-Origin' '*';
    }

    # Proxy requests to the UAM microservice
    location /profile/ {
        proxy_pass http://accounts:8007/profile/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy requests to the UAM microservice
    location /api/uam/register/ {
        proxy_pass http://accounts:8007/register/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/uam/login/ {
        proxy_pass http://accounts:8007/login/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/uam/logout/ {
        proxy_pass http://accounts:8007/logout/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/uam/friend-request/ {
        proxy_pass http://accounts:8007/friend-request/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /change-username/ {
        proxy_pass http://accounts:8007/change-username/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/uam/change-password/ {
        proxy_pass http://accounts:8007/change-password/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/uam/change-avatar/ {
        proxy_pass http://accounts:8007/change-avatar/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Pong API service WebSocket endpoint
    location /ws/game/ {
        proxy_pass http://pong-api:8000/ws/game/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # Pong API service
    location /api/pong/ {
        proxy_pass http://pong-api:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # Matchmaking service WebSocket endpoint
    location /ws/waiting-room/ {
        proxy_pass http://matchmaking:8000/ws/waiting-room/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # Matchmaking service HTTP endpoints
    location /api/matchmaking/ {
        proxy_pass http://matchmaking:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
    }

    # Game History service
    #
    # location /api/game-history/ {
    #     proxy_pass http://game-history:8000/api/finished-game/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header Origin $http_origin;
    # }
    #
    # location /api/game-history/ {
    #     proxy_pass http://game-history:8000/api/player/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header Origin $http_origin;
    # }
    #
    location /api/game-history/ {
        proxy_pass http://game-history:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # AI Opponent service
    location /api/ai-opponent/ {
        proxy_pass http://ai-opponent:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy all requests to the Frontend service
    location / {
        proxy_pass http://frontend:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # # Proxy requests to the UAM microservice
    # location /api/uam/ {
    #     proxy_pass http://uam:8000/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     # proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # # Proxy requests to the Matchmaking service
    # location /api/matchmaking/ {
    #     proxy_pass http://matchmaking:8001/;
    # }

    # # Proxy requests to the Game History service
    # location /api/game-history/ {
    #     proxy_pass http://game-history:8002/;
    # }

    # # Proxy requests to the AI Opponent service
    # location /api/ai-opponent/ {
    #     proxy_pass http://ai-opponent:8003/;
    # }

}
