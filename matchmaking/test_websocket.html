<!DOCTYPE html>
<html>

<head>
	<title>Matchmaking Test</title>
	<style>
		.container {
			margin: 20px;
		}

		.section {
			margin-bottom: 30px;
		}

		#messages {
			height: 400px;
			overflow-y: scroll;
			border: 1px solid #ccc;
			padding: 10px;
		}

		.danger-button {
			background-color: #dc3545;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 4px;
			cursor: pointer;
		}

		.danger-button:hover {
			background-color: #c82333;
		}

		.player-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 10px;
			margin-bottom: 15px;
		}

		.player-button {
			padding: 10px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			background-color: #4CAF50;
			color: white;
			transition: background-color 0.3s;
		}

		.player-button:hover {
			background-color: #45a049;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="section">
			<h3>Create Match/Tournament</h3>
			<select id="gameType">
				<option value="match">Regular Match (2 Players)</option>
				<option value="tournament4">Tournament (4 Players)</option>
				<option value="tournament8">Tournament (8 Players)</option>
			</select>
			<div class="player-grid">
				<button class="player-button" onclick="createGame(1)">Player 1</button>
				<button class="player-button" onclick="createGame(2)">Player 2</button>
				<button class="player-button" onclick="createGame(3)">Player 3</button>
				<button class="player-button" onclick="createGame(4)">Player 4</button>
				<button class="player-button" onclick="createGame(5)">Player 5</button>
				<button class="player-button" onclick="createGame(6)">Player 6</button>
				<button class="player-button" onclick="createGame(7)">Player 7</button>
				<button class="player-button" onclick="createGame(8)">Player 8</button>
				<button class="player-button" onclick="createGame(9)">Player 9</button>
				<button class="player-button" onclick="createGame(10)">Player 10</button>
				<button class="player-button" onclick="createGame(11)">Player 11</button>
				<button class="player-button" onclick="createGame(12)">Player 12</button>
			</div>
		</div>

		<div class="section">
			<h3>Join Game</h3>
			<select id="gameList">
				<option value="">Select a game to join...</option>
			</select>
			<div class="player-grid">
				<button class="player-button" onclick="joinGame(1)">Player 1</button>
				<button class="player-button" onclick="joinGame(2)">Player 2</button>
				<button class="player-button" onclick="joinGame(3)">Player 3</button>
				<button class="player-button" onclick="joinGame(4)">Player 4</button>
				<button class="player-button" onclick="joinGame(5)">Player 5</button>
				<button class="player-button" onclick="joinGame(6)">Player 6</button>
				<button class="player-button" onclick="joinGame(7)">Player 7</button>
				<button class="player-button" onclick="joinGame(8)">Player 8</button>
				<button class="player-button" onclick="joinGame(9)">Player 9</button>
				<button class="player-button" onclick="joinGame(10)">Player 10</button>
				<button class="player-button" onclick="joinGame(11)">Player 11</button>
				<button class="player-button" onclick="joinGame(12)">Player 12</button>
			</div>
		</div>

		<div class="section">
			<button class="danger-button" onclick="deleteAllGames()">Delete All Games</button>
		</div>

		<div id="messages"></div>
	</div>

	<script>
		const socket = new WebSocket('ws://localhost:8001/ws/waiting-room/');

		function createGame(playerId) {
			const gameType = document.getElementById('gameType').value;
			const message = {
				type: gameType === 'match' ? 'create_match' : 'create_tournament',
				player_id: playerId
			};

			if (gameType !== 'match') {
				message.max_players = gameType === 'tournament4' ? 4 : 8;
			}

			socket.send(JSON.stringify(message));
		}

		function joinGame(playerId) {
			const select = document.getElementById('gameList');
			if (!select.value) {
				addMessage('Error', 'Please select a game', true);
				return;
			}

			const [type, id] = select.value.split('-');
			const message = {
				type: type === 'match' ? 'join_match' : 'join_tournament',
				player_id: playerId,
				[type === 'match' ? 'match_id' : 'tournament_id']: parseInt(id)
			};

			socket.send(JSON.stringify(message));
		}

		function deleteAllGames() {
			if (confirm('Are you sure you want to delete all matches and tournaments?')) {
				const message = {
					type: 'delete_all_games'
				};
				socket.send(JSON.stringify(message));
			}
		}

		function updateGameList(data) {
			const select = document.getElementById('gameList');
			select.innerHTML = '<option value="">Select a game to join...</option>';

			// Add available matches
			data.matches?.filter(m => !m.player_2_id).forEach(match => {
				select.innerHTML += `
					<option value="match-${match.match_id}">
						Match ${match.match_id} (Created by Player ${match.player_1_id})
					</option>
				`;
			});

			// Add available tournaments
			data.tournaments?.filter(t => t.status === 'pending').forEach(tournament => {
				const playerCount = tournament.players.length;
				select.innerHTML += `
					<option value="tournament-${tournament.tournament_id}">
						${tournament.max_players}-Player Tournament ${tournament.tournament_id}
						(${playerCount}/${tournament.max_players} players)
					</option>
				`;
			});
		}

		function addGameDataMessage(type, data) {
			addMessage('Info', `Matches: ${JSON.stringify(data.available_games?.matches)}`, false);
			addMessage('Info', `Tournaments: ${JSON.stringify(data.available_games?.tournaments)}`, false);
		}
		socket.onmessage = function (e) {
			const data = JSON.parse(e.data);

			switch (data.type) {
				case 'error':
					addMessage('Error', data.message, true);
					break;

				case 'initial_games':
					addMessage('Info', `Matches: ${JSON.stringify(data.games.matches)}`, false);
					addMessage('Info', `Tournaments: ${JSON.stringify(data.games.tournaments)}`, false);
					updateGameList(data.games);
					break;

				case 'match_created':
					addMessage('Success', `Match ${data.id} created by Player ${data.creator_id}`);
					addGameDataMessage('Info', data);
					updateGameList(data.available_games);
					break;

				case 'tournament_created':
					addMessage('Success', `Tournament ${data.id} created by Player ${data.creator_id}`);
					addGameDataMessage('Info', data);
					updateGameList(data.available_games);
					break;

				case 'player_joined':
					addMessage('Success', `Player ${data.player_id} joined ${data.game_type} ${data.game_id}`);
					addGameDataMessage('Info', data);
					updateGameList(data.available_games);
					break;

				case 'tournament_started':
					addMessage('Info', `Tournament ${data.tournament_id} started! Matches created: ${JSON.stringify(data.matches)}`);
					addGameDataMessage('Info', data);
					updateGameList(data.available_games);
					break;

				case 'games_deleted':
					addMessage('Success', 'All matches and tournaments have been deleted');
					addGameDataMessage('Info', data);
					updateGameList(data.available_games);
					break;
			}
		};

		function requestInitialGameData() {
			socket.send(JSON.stringify({
				'type': 'get_games'
			}));
		}

		socket.onopen = () => {
			addMessage('System', 'Connected to server');
			requestInitialGameData();
		};
		socket.onerror = (e) => addMessage('Error', 'WebSocket error occurred', true);
		socket.onclose = () => addMessage('System', 'Connection closed');

		function addMessage(type, text, isError = false) {
			const messages = document.getElementById('messages');
			const time = new Date().toLocaleTimeString();
			messages.innerHTML += `
                <p style="color: ${isError ? 'red' : 'black'}">
                    [${time}] <strong>${type}:</strong> ${text}
                </p>
            `;
			messages.scrollTop = messages.scrollHeight;
		}
	</script>
</body>

</html>
